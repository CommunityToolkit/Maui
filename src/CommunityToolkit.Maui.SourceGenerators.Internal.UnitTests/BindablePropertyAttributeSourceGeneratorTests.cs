using System.Text.Unicode;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Testing;
using Microsoft.CodeAnalysis.Testing;
using Xunit;

namespace CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests;

public class BindablePropertyAttributeSourceGeneratorTests
{
	[Fact]
	public async Task GenerateBindableProperty_SimpleExample_GeneratesCorrectCode()
	{
		const string expectedAttribute =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator
			
			#pragma warning disable
			#nullable enable
			namespace CommunityToolkit.Maui;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			[AttributeUsage(AttributeTargets.Property, AllowMultiple = false, Inherited = false)]
			sealed partial class BindablePropertyAttribute : Attribute
			{
				public string? PropertyName { get; }
				public Type? DeclaringType { get; set; }
				public object? DefaultValue { get; set; }
				public BindingMode DefaultBindingMode { get; set; }
				public string ValidateValueMethodName { get; set; } = string.Empty;
				public string PropertyChangedMethodName { get; set; } = string.Empty;
				public string PropertyChangingMethodName { get; set; } = string.Empty;
				public string CoerceValueMethodName { get; set; } = string.Empty;
				public string DefaultValueCreatorMethodName { get; set; } = string.Empty;
			
				public BindablePropertyAttribute(string propertyName)
				{
					PropertyName = propertyName;
				}
			
				public BindablePropertyAttribute()
				{
				}
			}
			""";

		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;
			
			namespace TestNamespace;
			
			public partial class MyView : View
			{
			    [BindableProperty]
			    public string Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator
			#pragma warning disable
			#nullable enable
			namespace TestNamespace;
			public partial class MyView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref = "Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.MyView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
			    public partial string Text { get => (string)GetValue(TextProperty); set => SetValue(TextProperty, value); }
			}
			""";

		var test = new CSharpSourceGeneratorTest<BindablePropertyAttributeSourceGenerator, DefaultVerifier>
		{
			ReferenceAssemblies = ReferenceAssemblies.Net.Net90,
			TestCode = source
		};
		test.TestState.GeneratedSources.Add((typeof(BindablePropertyAttributeSourceGenerator), "BindablePropertyAttribute.g.cs", expectedAttribute));
		test.TestState.GeneratedSources.Add((typeof(BindablePropertyAttributeSourceGenerator), "MyView.g.cs", expectedGenerated));

		await test.RunAsync(TestContext.Current.CancellationToken);
	}

	[Fact]
	public async Task GenerateBindableProperty_WithCustomPropertyName_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty("CustomName")]
			    public string Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="CustomName"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty CustomNameProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("CustomName", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial string CustomName
			    {
			        get => (string)GetValue(CustomNameProperty);
			        set => SetValue(CustomNameProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_WithDefaultValue_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty(DefaultValue = "Hello")]
			    public string Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.TestView), (System.String)Hello, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial string Text
			    {
			        get => (string)GetValue(TextProperty);
			        set => SetValue(TextProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_WithNewKeyword_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty]
			    public new string Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public new partial string Text
			    {
			        get => (string)GetValue(TextProperty);
			        set => SetValue(TextProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_NullableReferenceType_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty]
			    public string? Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial string? Text
			    {
			        get => (string?)GetValue(TextProperty);
			        set => SetValue(TextProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_MultipleProperties_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty]
			    public string Text { get; set; }

			    [BindableProperty]
			    public int Number { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial string Text
			    {
			        get => (string)GetValue(TextProperty);
			        set => SetValue(TextProperty, value);
			    }

			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Number"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty NumberProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Number", typeof(int), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial int Number
			    {
			        get => (int)GetValue(NumberProperty);
			        set => SetValue(NumberProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_WithAllParameters_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    [BindableProperty(
			        DefaultValue = 42,
			        DefaultBindingMode = BindingMode.TwoWay,
			        ValidateValueMethodName = "ValidateValue",
			        PropertyChangedMethodName = "OnPropertyChanged",
			        PropertyChangingMethodName = "OnPropertyChanging",
			        CoerceValueMethodName = "CoerceValue",
			        DefaultValueCreatorMethodName = "CreateDefaultValue")]
			    public int Value { get; set; }

			    static bool ValidateValue(BindableObject bindable, object value) => true;
			    static void OnPropertyChanged(BindableObject bindable, object oldValue, object newValue) { }
			    static void OnPropertyChanging(BindableObject bindable, object oldValue, object newValue) { }
			    static object CoerceValue(BindableObject bindable, object value) => value;
			    static object CreateDefaultValue(BindableObject bindable) => 0;
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			public partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Value"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty ValueProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Value", typeof(int), typeof(TestNamespace.TestView), (System.Int32)42, (Microsoft.Maui.Controls.BindingMode)Microsoft.Maui.Controls.BindingMode.TwoWay, ValidateValue, OnPropertyChanged, OnPropertyChanging, CoerceValue, CreateDefaultValue);

			    public partial int Value
			    {
			        get => (int)GetValue(ValueProperty);
			        set => SetValue(ValueProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_InternalClass_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			internal partial class TestView : View
			{
			    [BindableProperty]
			    public string Text { get; set; }
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable

			namespace TestNamespace;

			internal partial class TestView
			{
			    /// <summary>
			    /// Backing BindableProperty for the <see cref="Text"/> property.
			    /// </summary>
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
			    global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

			    public partial string Text
			    {
			        get => (string)GetValue(TextProperty);
			        set => SetValue(TextProperty, value);
			    }
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateBindableProperty_NoAttribute_GeneratesNoCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
			    public string Text { get; set; }
			}
			""";

		await VerifySourceGeneratorAsync(source, string.Empty);
	}

	[Fact]
	public async Task GenerateBindableProperty_EmptyClass_GeneratesAttributeOnly()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			"""
			using Microsoft.Maui.Controls;

			namespace TestNamespace;

			public partial class TestView : View
			{
				[BindableProperty]
				public partial string Location { get; set; }
			}
			""";

		const string expectedAttribute = 
			/* language=C#-test */
			//lang=csharp
			"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

			#pragma warning disable
			#nullable enable
			namespace CommunityToolkit.Maui;

			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			[AttributeUsage(AttributeTargets.Property, AllowMultiple = false, Inherited = false)]
			sealed partial class BindablePropertyAttribute : Attribute
			{
				public string? PropertyName { get; }
				public Type? DeclaringType { get; set; }
				public object? DefaultValue { get; set; }
				public BindingMode DefaultBindingMode { get; set; }
				public string ValidateValueMethodName { get; set; } = string.Empty;
				public string PropertyChangedMethodName { get; set; } = string.Empty;
				public string PropertyChangingMethodName { get; set; } = string.Empty;
				public string CoerceValueMethodName { get; set; } = string.Empty;
				public string DefaultValueCreatorMethodName { get; set; } = string.Empty;

				public BindablePropertyAttribute(string propertyName)
				{
					PropertyName = propertyName;
				}

				public BindablePropertyAttribute()
				{
				}
			}
			""";

		await VerifySourceGeneratorAsync(source, string.Empty, expectedAttribute);
	}

	static async Task VerifySourceGeneratorAsync(string source, string expectedGenerated, string? expectedAttribute = null)
	{
		var test = new CSharpSourceGeneratorTest<BindablePropertyAttributeSourceGenerator, DefaultVerifier>
		{
			TestState =
			{
				Sources = { source },
				ReferenceAssemblies = ReferenceAssemblies.Net.Net90,
				AdditionalReferences =
				{
					MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableObject).Assembly.Location),
					MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableProperty).Assembly.Location),
				}
			}
		};

		if (expectedAttribute != null)
		{
			test.TestState.GeneratedSources.Add(("CommunityToolkit.Maui.SourceGenerators.Internal/CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator/BindablePropertyAttribute.g.cs", expectedAttribute));
		}

		if (!string.IsNullOrEmpty(expectedGenerated))
		{
			test.TestState.GeneratedSources.Add(("TestView.g.cs", expectedGenerated));
		}

		await test.RunAsync(TestContext.Current.CancellationToken);
	}
}