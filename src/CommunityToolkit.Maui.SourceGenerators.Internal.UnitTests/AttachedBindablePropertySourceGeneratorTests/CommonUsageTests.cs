using System.Threading.Tasks;
using Xunit;

namespace CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests.AttachedBindablePropertySourceGeneratorTests;

public class CommonUsageTests : BaseAttachedBindablePropertyAttributeSourceGeneratorTest
{
	[Fact]
	public async Task GenerateAttachedBindableProperty_SimpleExample_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			$$"""
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};

            public partial class {{defaultTestClassName}} : View
            {
                [AttachedBindableProperty]
                public partial string Text { get; set; }
            }
            """;

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			$$"""
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator
            #pragma warning disable
            #nullable enable
            using global::Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};
            public partial class {{defaultTestClassName}}
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref = "Text"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Text", typeof(string), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
                public partial string Text { get => (string)GetValue(TextProperty); set => SetValue(TextProperty, value); }

                public static string GetText(BindableObject view) => (string)view.GetValue(TextProperty);
                public static void SetText(BindableObject view, string value) => view.SetValue(TextProperty, value);
            }
            """;

		await VerifyAttachedSourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateAttachedBindableProperty_WithNewKeyword_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			$$"""
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};

            public partial class {{defaultTestClassName}} : View
            {
                [AttachedBindableProperty]
                public new partial string Text { get; set; }
            }
            """;

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			$$"""
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator
            #pragma warning disable
            #nullable enable
            using global::Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};
            public partial class {{defaultTestClassName}}
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref = "Text"/> property.
                /// </summary>
                public new static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Text", typeof(string), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
                public new partial string Text { get => (string)GetValue(TextProperty); set => SetValue(TextProperty, value); }

                public static string GetText(BindableObject view) => (string)view.GetValue(TextProperty);
                public static void SetText(BindableObject view, string value) => view.SetValue(TextProperty, value);
            }
            """;

		await VerifyAttachedSourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateAttachedBindableProperty_NullableReferenceType_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			$$"""
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};

            public partial class {{defaultTestClassName}} : View
            {
                [AttachedBindableProperty]
                public partial string? Text { get; set; }
            }
            """;

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			$$"""
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator
            #pragma warning disable
            #nullable enable
            using global::Microsoft.Maui.Controls;

            namespace {{defaultTestNamespace}};
            public partial class {{defaultTestClassName}}
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref = "Text"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Text", typeof(string), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
                public partial string? Text { get => (string)GetValue(TextProperty); set => SetValue(TextProperty, value); }

                public static string? GetText(BindableObject view) => (string)view.GetValue(TextProperty);
                public static void SetText(BindableObject view, string? value) => view.SetValue(TextProperty, value);
            }
            """;

		await VerifyAttachedSourceGeneratorAsync(source, expectedGenerated);
	}

	[Fact]
	public async Task GenerateAttachedBindableProperty_MultipleProperties_GeneratesCorrectCode()
	{
		const string source =
			/* language=C#-test */
			//lang=csharp
			$$"""
        using CommunityToolkit.Maui;
        using Microsoft.Maui.Controls;

        namespace {{defaultTestNamespace}};

        public partial class {{defaultTestClassName}} : View
        {
            [AttachedBindableProperty]
            public partial string Text { get; set; }

            [AttachedBindableProperty]
            public partial int Number { get; set; }
        }
        """;

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			$$"""
        // <auto-generated>
        // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator
        #pragma warning disable
        #nullable enable
        using global::Microsoft.Maui.Controls;

        namespace {{defaultTestNamespace}};
        public partial class {{defaultTestClassName}}
        {
            /// <summary>
            /// Backing BindableProperty for the <see cref = "Text"/> property.
            /// </summary>
            public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Text", typeof(string), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
            public partial string Text { get => (string)GetValue(TextProperty); set => SetValue(TextProperty, value); }

            public static string GetText(BindableObject view) => (string)view.GetValue(TextProperty);
            public static void SetText(BindableObject view, string value) => view.SetValue(TextProperty, value);
            /// <summary>
            /// Backing BindableProperty for the <see cref = "Number"/> property.
            /// </summary>
            public static readonly global::Microsoft.Maui.Controls.BindableProperty NumberProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Number", typeof(int), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);
            public partial int Number { get => (int)GetValue(NumberProperty); set => SetValue(NumberProperty, value); }

            public static int GetNumber(BindableObject view) => (int)view.GetValue(NumberProperty);
            public static void SetNumber(BindableObject view, int value) => view.SetValue(NumberProperty, value);
        }
        """;

		await VerifyAttachedSourceGeneratorAsync(source, expectedGenerated);
	}
}