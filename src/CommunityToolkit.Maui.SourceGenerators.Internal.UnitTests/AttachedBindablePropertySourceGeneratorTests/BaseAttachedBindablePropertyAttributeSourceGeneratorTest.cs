using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Testing;
using Microsoft.CodeAnalysis.Testing;
using System.IO;
using System.Collections.Generic;
using Xunit;

namespace CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests.AttachedBindablePropertySourceGeneratorTests;

public class BaseAttachedBindablePropertyAttributeSourceGeneratorTest : CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests.BaseTest
{
    protected const string defaultTestClassName = "TestView";
    protected const string defaultTestNamespace = "TestNamespace";

    protected const string expectedAttribute =
        /* language=C#-test */
        //lang=csharp
        $$"""
      // <auto-generated>
      // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator

      #pragma warning disable
      #nullable enable
      namespace CommunityToolkit.Maui;

      [global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
      [global::System.AttributeUsage(global::System.AttributeTargets.Property, AllowMultiple = false, Inherited = false)]
      [global::System.Diagnostics.CodeAnalysis.Experimental("{{AttachedBindablePropertySourceGenerator.BindablePropertyAttributeExperimentalDiagnosticId}}")]
      sealed partial class AttachedBindablePropertyAttribute : global::System.Attribute
      {
          public string? PropertyName { get; }
          public global::System.Type? DeclaringType { get; set; }
          public global::Microsoft.Maui.Controls.BindingMode DefaultBindingMode { get; set; }
          public string ValidateValueMethodName { get; set; } = string.Empty;
          public string PropertyChangedMethodName { get; set; } = string.Empty;
          public string PropertyChangingMethodName { get; set; } = string.Empty;
          public string CoerceValueMethodName { get; set; } = string.Empty;
          public string DefaultValueCreatorMethodName { get; set; } = string.Empty;
      }
      """;

    protected static async Task VerifyAttachedSourceGeneratorAsync(string source, string expectedGenerated)
    {
        const string sourceGeneratorNamespace = "CommunityToolkit.Maui.SourceGenerators.Internal";
        const string attachedBindablePropertyAttributeGeneratedFileName = "AttachedBindablePropertyAttribute.g.cs";
        var attachedSourceGeneratorFullName = typeof(AttachedBindablePropertySourceGenerator).FullName ?? throw new InvalidOperationException("Source Generator Type Path cannot be null");

        var test = new AttachedBindablePropertyTest
        {
#if NET10_0
            ReferenceAssemblies = Microsoft.CodeAnalysis.Testing.ReferenceAssemblies.Net.Net100,
#else
#error ReferenceAssemblies must be updated to current version of .NET
#endif
            TestState =
            {
                Sources = { source },

                AdditionalReferences =
                {
                    MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableObject).Assembly.Location),
                    MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableProperty).Assembly.Location),
                    MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindingMode).Assembly.Location)
                }
            }
        };

        var expectedAttributeText = Microsoft.CodeAnalysis.Text.SourceText.From(expectedAttribute, System.Text.Encoding.UTF8);
        // Use the same prefix the test harness uses so the expected generated file path matches actual
        var attributeFilePath = Path.Combine(sourceGeneratorNamespace, attachedSourceGeneratorFullName, attachedBindablePropertyAttributeGeneratedFileName);
        test.TestState.GeneratedSources.Add((attributeFilePath, expectedAttributeText));

        if (!string.IsNullOrEmpty(expectedGenerated))
        {
            var expectedGeneratedText = Microsoft.CodeAnalysis.Text.SourceText.From(expectedGenerated, System.Text.Encoding.UTF8);
            var generatedFilePath = Path.Combine(sourceGeneratorNamespace, attachedSourceGeneratorFullName, $"{defaultTestClassName}.g.cs");
            test.TestState.GeneratedSources.Add((generatedFilePath, expectedGeneratedText));
        }

        await test.RunAsync(TestContext.Current.CancellationToken);
    }

    sealed class AttachedBindablePropertyTest : CSharpSourceGeneratorTest<AttachedBindablePropertySourceGenerator, DefaultVerifier>
    {
        protected override CompilationOptions CreateCompilationOptions()
        {
            var compilationOptions = base.CreateCompilationOptions();

            return compilationOptions.WithSpecificDiagnosticOptions(new Dictionary<string, ReportDiagnostic>
            {
                { AttachedBindablePropertySourceGenerator.BindablePropertyAttributeExperimentalDiagnosticId, ReportDiagnostic.Warn }
            });
        }
    }
}
