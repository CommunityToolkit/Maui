using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Testing;
using Microsoft.CodeAnalysis.Testing;
using Xunit;

namespace CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests;

public class EdgeCaseTests
{
    [Fact]
    public async Task GenerateBindableProperty_PropertyWithReservedKeywords_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty]
                public string @class { get; set; }

                [BindableProperty]
                public string @namespace { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="class"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty classProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("class", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string @class
                {
                    get => (string)GetValue(classProperty);
                    set => SetValue(classProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="namespace"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty namespaceProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("namespace", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string @namespace
                {
                    get => (string)GetValue(namespaceProperty);
                    set => SetValue(namespaceProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_NullableValueTypes_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty]
                public int? NullableInt { get; set; }

                [BindableProperty]
                public DateTime? NullableDateTime { get; set; }

                [BindableProperty]
                public bool? NullableBool { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="NullableInt"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty NullableIntProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("NullableInt", typeof(int?), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial int? NullableInt
                {
                    get => (int?)GetValue(NullableIntProperty);
                    set => SetValue(NullableIntProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="NullableDateTime"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty NullableDateTimeProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("NullableDateTime", typeof(DateTime?), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial DateTime? NullableDateTime
                {
                    get => (DateTime?)GetValue(NullableDateTimeProperty);
                    set => SetValue(NullableDateTimeProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="NullableBool"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty NullableBoolProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("NullableBool", typeof(bool?), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial bool? NullableBool
                {
                    get => (bool?)GetValue(NullableBoolProperty);
                    set => SetValue(NullableBoolProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_ArrayTypes_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty]
                public string[] StringArray { get; set; }

                [BindableProperty]
                public int[,] MultiDimensionalArray { get; set; }

                [BindableProperty]
                public byte[][] JaggedArray { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="StringArray"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty StringArrayProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("StringArray", typeof(string[]), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string[] StringArray
                {
                    get => (string[])GetValue(StringArrayProperty);
                    set => SetValue(StringArrayProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="MultiDimensionalArray"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty MultiDimensionalArrayProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("MultiDimensionalArray", typeof(int[,]), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial int[,] MultiDimensionalArray
                {
                    get => (int[,])GetValue(MultiDimensionalArrayProperty);
                    set => SetValue(MultiDimensionalArrayProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="JaggedArray"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty JaggedArrayProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("JaggedArray", typeof(byte[][]), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial byte[][] JaggedArray
                {
                    get => (byte[][])GetValue(JaggedArrayProperty);
                    set => SetValue(JaggedArrayProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_LongNamespaces_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace Very.Long.Namespace.With.Many.Segments.TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty]
                public string Text { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace Very.Long.Namespace.With.Many.Segments.TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="Text"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(Very.Long.Namespace.With.Many.Segments.TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string Text
                {
                    get => (string)GetValue(TextProperty);
                    set => SetValue(TextProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_GlobalNamespace_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            public partial class TestView : View
            {
                [BindableProperty]
                public string Text { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace ;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="Text"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Text", typeof(string), typeof(TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string Text
                {
                    get => (string)GetValue(TextProperty);
                    set => SetValue(TextProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_SpecialCharactersInPropertyName_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty("Property_With_Underscores")]
                public string PropertyWithUnderscores { get; set; }

                [BindableProperty("Property123WithNumbers")]
                public string PropertyWithNumbers { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="Property_With_Underscores"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty Property_With_UnderscoresProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Property_With_Underscores", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string Property_With_Underscores
                {
                    get => (string)GetValue(Property_With_UnderscoresProperty);
                    set => SetValue(Property_With_UnderscoresProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="Property123WithNumbers"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty Property123WithNumbersProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Property123WithNumbers", typeof(string), typeof(TestNamespace.TestView), null, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial string Property123WithNumbers
                {
                    get => (string)GetValue(Property123WithNumbersProperty);
                    set => SetValue(Property123WithNumbersProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    [Fact]
    public async Task GenerateBindableProperty_WithComplexDefaultValues_GeneratesCorrectCode()
    {
        const string source = """
            using CommunityToolkit.Maui;
            using Microsoft.Maui.Controls;

            namespace TestNamespace;

            public partial class TestView : View
            {
                [BindableProperty(DefaultValue = true)]
                public bool IsEnabled { get; set; }

                [BindableProperty(DefaultValue = 3.14)]
                public double Pi { get; set; }

                [BindableProperty(DefaultValue = 'A')]
                public char Letter { get; set; }
            }
            """;

        const string expectedGenerated = """
            // <auto-generated>
            // See: CommunityToolkit.Maui.SourceGenerators.Internal.BindablePropertyAttributeSourceGenerator

            #pragma warning disable
            #nullable enable

            namespace TestNamespace;

            public partial class TestView
            {
                /// <summary>
                /// Backing BindableProperty for the <see cref="IsEnabled"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty IsEnabledProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("IsEnabled", typeof(bool), typeof(TestNamespace.TestView), (System.Boolean)true, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial bool IsEnabled
                {
                    get => (bool)GetValue(IsEnabledProperty);
                    set => SetValue(IsEnabledProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="Pi"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty PiProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Pi", typeof(double), typeof(TestNamespace.TestView), (System.Double)3.14, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial double Pi
                {
                    get => (double)GetValue(PiProperty);
                    set => SetValue(PiProperty, value);
                }

                /// <summary>
                /// Backing BindableProperty for the <see cref="Letter"/> property.
                /// </summary>
                public static readonly global::Microsoft.Maui.Controls.BindableProperty LetterProperty = 
                global::Microsoft.Maui.Controls.BindableProperty.Create("Letter", typeof(char), typeof(TestNamespace.TestView), (System.Char)A, Microsoft.Maui.Controls.BindingMode.OneWay, null, null, null, null, null);

                public partial char Letter
                {
                    get => (char)GetValue(LetterProperty);
                    set => SetValue(LetterProperty, value);
                }
            }
            """;

        await VerifySourceGeneratorAsync(source, expectedGenerated);
    }

    static async Task VerifySourceGeneratorAsync(string source, string expectedGenerated)
    {
        var test = new CSharpSourceGeneratorTest<BindablePropertyAttributeSourceGenerator, DefaultVerifier>
        {
            TestState =
            {
                Sources = { source },
                ReferenceAssemblies = ReferenceAssemblies.Net.Net90,
                AdditionalReferences =
                {
                    MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableObject).Assembly.Location),
                    MetadataReference.CreateFromFile(typeof(Microsoft.Maui.Controls.BindableProperty).Assembly.Location),
                }
            }
        };

        if (!string.IsNullOrEmpty(expectedGenerated))
        {
            // Extract class name from the expected generated code for the filename
            var lines = expectedGenerated.Split('\n');
            var classLine = lines.FirstOrDefault(l => l.Contains("partial class"));
            var className = classLine?.Split("partial class ")[1]?.Split(' ')[0] ?? "Generated";
            
            test.TestState.GeneratedSources.Add(($"{className}.g.cs", expectedGenerated));
        }

        await test.RunAsync();
    }
}
