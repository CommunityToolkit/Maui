namespace CommunityToolkit.Maui.SourceGenerators.Internal.UnitTests.AttachedBindablePropertyAttributeSourceGeneratorTests;

public abstract class BaseAttachedBindablePropertyAttributeSourceGeneratorTest : BaseTest
{
	const string generatedBindablePropertyAttributeFileName = "AttachedBindablePropertyAttribute.g.cs";
	const string expectedAttribute =
		/* language=C#-test */
		//lang=csharp
		$$"""
		  // <auto-generated>
		  // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator

		  #pragma warning disable
		  #nullable enable
		  namespace CommunityToolkit.Maui;

		  [global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
		  [global::System.AttributeUsage(global::System.AttributeTargets.Class | global::System.AttributeTargets.Constructor, AllowMultiple = true, Inherited = false)]
		  [global::System.Diagnostics.CodeAnalysis.Experimental("{{BindablePropertyDiagnostic.BindablePropertyAttributeExperimentalDiagnosticId}}")]
		  public sealed partial class AttachedBindablePropertyAttribute<T>(string propertyName, bool isNullable = false) : global::System.Attribute where T : notnull
		  {
		  	public string PropertyName { get; } = propertyName;
		  	public bool DeclaringTypeIsNullable { get; } = isNullable;
		  	public T DefaultValue { get; init; }
		  	public global::Microsoft.Maui.Controls.BindingMode DefaultBindingMode { get; init; }
		  	public string ValidateValueMethodName { get; init; } = string.Empty;
		  	public string PropertyChangedMethodName { get; init; } = string.Empty;
		  	public string PropertyChangingMethodName { get; init; } = string.Empty;
		  	public string CoerceValueMethodName { get; init; } = string.Empty;
		  	public string DefaultValueCreatorMethodName { get; init; } = string.Empty;
		  	public string? BindablePropertyXmlDocumentation { get; init; }
		  	public string? GetterMethodXmlDocumentation { get; init; }
		  	public string? SetterMethodXmlDocumentation { get; init; }
		  	public global::CommunityToolkit.Maui.AccessModifier BindablePropertyAccessibility { get; init; } = global::CommunityToolkit.Maui.AccessModifier.Public;
		  	public global::CommunityToolkit.Maui.AccessModifier GetterAccessibility { get; init; } = global::CommunityToolkit.Maui.AccessModifier.Public;
		  	public global::CommunityToolkit.Maui.AccessModifier SetterAccessibility { get; init; } = global::CommunityToolkit.Maui.AccessModifier.Public;
		  }
		  """;

	const string generatedEnumFileName = "AccessModifier.g.cs";
	const string expectedEnum =
		/* language=C#-test */
		//lang=csharp
		$$"""
		  // <auto-generated>
		  // See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertySourceGenerator

		  #pragma warning disable
		  #nullable enable
		  namespace CommunityToolkit.Maui;

		  public enum AccessModifier
		  {
		  	Public = 0,
		  	Internal = 1,
		  	ProtectedInternal = 2,
		  	Protected = 3,
		  	PrivateProtected = 4,
		  	Private = 5,
		  	None = 6
		  }
		  """;

	protected static Task VerifySourceGeneratorAsync(string source, params List<(string FileName, string GeneratedFile)> expectedGeneratedFilesList)
	{
		expectedGeneratedFilesList.Add((generatedBindablePropertyAttributeFileName, expectedAttribute));
		expectedGeneratedFilesList.Add((generatedEnumFileName, expectedEnum));

		return VerifySourceGeneratorAsync<AttachedBindablePropertyAttributeSourceGenerator>(source, expectedGeneratedFilesList);
	}


	protected static Task VerifySourceGeneratorAsync(string source, string expectedGeneratedFile)
	{
		List<(string FileName, string GeneratedFile)> expectedGeneratedFilesList =
		[
			(generatedBindablePropertyAttributeFileName, expectedAttribute),
			(generatedEnumFileName, expectedEnum),
			($"{defaultTestClassName}.g.cs", expectedGeneratedFile)
		];

		return VerifySourceGeneratorAsync<AttachedBindablePropertyAttributeSourceGenerator>(source, expectedGeneratedFilesList);
	}
	
		[Fact]
	public async Task GenerateAttachedBindableProperty_CustomXmlDocumentation_GeneratesCorrectCode()
	{
		const string bindablePropertyXmlDocumentation = "///<summary>This is the custom XML documentation for the TextProperty</summary>";
		const string getterMethodXmlDocumentation = "///<summary>This is the custom XML documentation for the GetText method.</summary>";
		const string setterMethodXmlDocumentation = "///<summary>This is the custom XML documentation for the SetText method.</summary>";

		const string source =
			/* language=C#-test */
			//lang=csharp
			$$"""
			using CommunityToolkit.Maui;
			using Microsoft.Maui.Controls;

			namespace {{defaultTestNamespace}};

			public partial class {{defaultTestClassName}} : View
			{
			    [AttachedBindableProperty<string>("Text", BindablePropertyXmlDocumentation = "{{bindablePropertyXmlDocumentation}}", GetterMethodXmlDocumentation = "{{getterMethodXmlDocumentation}}", SetterMethodXmlDocumentation = "{{setterMethodXmlDocumentation}}")]
			    public {{defaultTestClassName}}()
				{
				}
			}
			""";

		const string expectedGenerated =
			/* language=C#-test */
			//lang=csharp
			$$"""
			// <auto-generated>
			// See: CommunityToolkit.Maui.SourceGenerators.Internal.AttachedBindablePropertyAttributeSourceGenerator
			#pragma warning disable
			#nullable enable
			namespace {{defaultTestNamespace}};
			public partial class {{defaultTestClassName}}
			{
			    {{bindablePropertyXmlDocumentation}}
			    public static readonly global::Microsoft.Maui.Controls.BindableProperty TextProperty = global::Microsoft.Maui.Controls.BindableProperty.CreateAttached("Text", typeof(string), typeof({{defaultTestNamespace}}.{{defaultTestClassName}}), null, (Microsoft.Maui.Controls.BindingMode)0, null, null, null, null, null);
			    {{getterMethodXmlDocumentation}}
			    public static string GetText(global::Microsoft.Maui.Controls.BindableObject bindable) => (string)bindable.GetValue(TextProperty);
			    {{setterMethodXmlDocumentation}}
			    public static void SetText(global::Microsoft.Maui.Controls.BindableObject bindable, string value) => bindable.SetValue(TextProperty, value);
			}
			""";

		await VerifySourceGeneratorAsync(source, expectedGenerated);
	}
}